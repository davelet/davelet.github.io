---
layout: post
title: Elasticsearch ä¸­çš„è„šæœ¬ç¼–ç¨‹èƒ½åŠ›
categories: [dev]
tags: [elasticsearch]
---

elasticsearch å’Œ å…³ç³»å‹æ•°æ®åº“åœ¨ä½¿ç”¨ä¸Šç±»ä¼¼ï¼Œéƒ½æ˜¯å»ºè¡¨ï¼ˆåˆ›å»ºmappingï¼‰ã€æ’å…¥ã€æŸ¥è¯¢ã€åˆ é™¤ã€æ›´æ–°ã€è¡¨ç»“æ„å˜æ›´ï¼ˆmapping å˜æ›´ï¼‰ç­‰ç­‰ã€‚åŸºäºåŸºæœ¬çš„å¢åˆ æ”¹æŸ¥ç”¨çš„æœ€å¤šä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè€Œmappingç»“æ„çš„å¤„ç†è¦ç›¸å¯¹å¤æ‚ä¸€ç‚¹ã€‚è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨es çš„è„šæœ¬èƒ½åŠ›è½»æ¾å˜æ›´mapping ç»“æ„ã€‚

> ä¸ºæˆç†Ÿçš„ä¸­é—´ä»¶æä¾›ç¼–ç¨‹èƒ½åŠ›æ­£æˆä¸ºä¸­é—´ä»¶çƒ­è¡·çš„èƒ½åŠ›ï¼Œæ¯”å¦‚redisä¹Ÿæ”¯æŒluaç¼–ç¨‹ï¼ˆã€Š[åœ¨Redisä¸­ä½¿ç”¨Luaè„šæœ¬](/redislua/)ã€‹ï¼‰

# ã€‡ es è„šæœ¬èƒ½åŠ›ç®€ä»‹

esè„šæœ¬èƒ½å®ç°ä¸€äº›rest apiæ— æ³•æå®šçš„äº‹æƒ…ï¼Œä»è¿™ä¸€ä¸ªè§’åº¦çœ‹ï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰é‡å¤§ï¼šå› ä¸ºå®ƒæœ‰ä¸€ä¸ªæ— æ³•è¢«ä»£æ›¿çš„èƒ½åŠ›ã€‚å¦‚æœæˆ‘ä»¬è‡ªå·±èº«ä¸Šä¹Ÿæœ‰åˆ«äººæ— æ³•ä»£æ›¿çš„ç‰¹è´¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ˜¯è¿™ä¸ªä¸–ç•Œé‡è¦çš„ç»„æˆéƒ¨åˆ†ğŸ˜ã€‚

> å¯æƒœæˆ‘ä»¬æ²¡æœ‰ï¼Œæ‰€ä»¥åœ°çƒç¦»äº†æˆ‘ä»¬è¿˜æ˜¯åœ¨è½¬ğŸ˜­

ä»1.4ç‰ˆæœ¬å¼€å§‹ï¼Œesæ¨èä½¿ç”¨groovyåšä¸ºé»˜è®¤è„šæœ¬ã€‚å®é™…ä¸Šï¼Œes æ”¯æŒå¥½å‡ ç§è„šæœ¬å¼•æ“ï¼Œé™¤äº†groovyï¼Œè¿˜æœ‰å¤§å®¶ç†Ÿæ‚‰çš„js/pythonï¼Œè¿˜æœ‰Expression/Mustache/mvelã€‚å¤§å®¶å¯ä»¥è‡ªè¡Œäº†è§£ä¸€ä¸‹ã€‚

é€šè¿‡esè„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°esè®°å½•çš„å­—æ®µã€å¢åŠ å­—æ®µã€åˆ é™¤å­—æ®µï¼Œè€Œåé¢è¿™ä¸¤ä¸ªèƒ½åŠ›ï¼Œä¸ä½¿ç”¨è„šæœ¬çš„è¯å®ç°èµ·æ¥å¾ˆè´¹åŠ²ã€‚

# å£¹ æ›´æ–°å­—æ®µ

æˆ‘ä»¬å…ˆæ¥åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼š

```
curl -XPUT 'localhost:9200/testindex/_doc/1' -H 'content-Type:application/json' -d '{
   "marks": {
     "physics": 48,
     "maths": 45,
     "chemistry": 44
   },
   "remarks": [
     "hard working",
     "intelligent"
   ]
 }'
```

è¿™æ¡è®°å½•åŒ…å«ä¸¤ä¸ªnestedå­—æ®µï¼Œå¹¶ä¸”æ²¡æœ‰æŒ‡æ˜å­—æ®µç±»å‹ï¼Œæ‰€ä»¥esä¼šè‡ªåŠ¨æ˜ å°„ï¼š

```
"marks": {
    "properties": {
        "chemistry": {
            "type": "long"
        },
        "maths": {
            "type": "long"
        },
        "physics": {
            "type": "long"
        }
    }
},
"remarks": {
    "type": "text",
    "fields": {
        "keyword": {
            "ignore_above": 256,
            "type": "keyword"
        }
    }
}
```

æ¥ä¸‹æ¥é€šè¿‡è„šæœ¬æ›´æ–°ç‰©ç†è¯¾çš„åˆ†æ•°ä¸º59ï¼ˆå·®ç‚¹åŠæ ¼ï¼‰ï¼š

> å¸Œæœ›ä½ å·²ç»çŸ¥é“ä¸ä½¿ç”¨è„šæœ¬æ˜¯å¦‚ä½•æ›´æ–°è®°å½•çš„

```
curl -XPOST 'localhost:9200/testindex/_doc/1/_update' -H 'Content-Type: application/json' -d '{
    "script" : "ctx._source.marks.physics = 59"
}'
```

æˆ‘ä»¬çœ‹ä¸€ä¸‹è¯·æ±‚æ ¼å¼ï¼šjsonå‚æ•°æœ‰ä¸€ä¸ªå­—æ®µå«scriptï¼Œé‡Œé¢é€šè¿‡ctxçš„_sourceæ‹¿åˆ°è®°å½•ï¼Œç„¶åé€šè¿‡ç‚¹å·æŒ‡æ˜markså­—æ®µçš„physicså­—æ®µçš„å€¼ã€‚

# è´° å¢åŠ å­—æ®µ

ä¸ä½¿ç”¨è„šæœ¬å¦‚ä½•å¢åŠ å­—æ®µï¼Ÿè¿™ä¸ªå·²ç»ä¸æ˜¯ä¸€ä¸ªå¸¸è§„é—®é¢˜ï¼Œè™½ç„¶åšæ³•ç®€å•ï¼Œä½†æ˜¯äº†è§£çš„äººä¸å¤šï¼š

```
 curl -XPUT 'http://127.0.0.1:9200/testindex/_mapping/_doc?pretty' -H 'Content-Type: application/json' -d'
{
  "properties": {
    "long_followerCount": {
      "type": "long"
    }
  }
}'
```

é€šè¿‡index/_mapping/typeçš„PUTè¯·æ±‚ç›´æ¥ä¼ å…¥ä¸€ä¸ªå­—æ®µå°±å¯ä»¥æ–°å¢ã€‚

é‚£é€šè¿‡è„šæœ¬æ€ä¹ˆå®ç°å‘¢ï¼Ÿ

```
curl -XPOST 'localhost:9200/testindex/_doc/1/_update' -H 'Content-Type: application/json' -d '{
    "script" : "ctx._source.marks.english = 41"
}'
```

ç›´æ¥å†™å…¥ä¸€ä¸ªå€¼å°±å®Œæˆäº†æ–°å¢ã€‚å½“ç„¶æ˜¯åŠ¨æ€ç»“æ„äº†ã€‚

ç°åœ¨æ•´ä¸ªmappingæ˜¯ï¼š

```
"properties": {
    "marks": {
        "properties": {
            "chemistry": {
                "type": "long"
            },
            "maths": {
                "type": "long"
            },
            "physics": {
                "type": "long"
            },
            "english": {
                "type": "long"
            }
        }
    },
    "long_followerCount": {
        "type": "long"
    },
    "remarks": {
        "type": "text",
        "fields": {
            "keyword": {
                "ignore_above": 256,
                "type": "keyword"
            }
        }
    }
}
```

# å åˆ é™¤å­—æ®µ

é€šè¿‡è„šæœ¬åˆ é™¤å­—æ®µä¹Ÿå¾ˆç®€å•ï¼š

```
curl -XPOST 'localhost:9200/testindex/_doc/1/_update' -H 'Content-Type: application/json' -d '{
  "script": "ctx._source.marks.remove(\"physics\")"
}'

curl -XPOST 'localhost:9200/testindex/_doc/1/_update' -H 'Content-Type: application/json' -d '{
  "script": "ctx._source.remove(\"marks\")"
}'
```
ä¸Šé¢åˆ†åˆ«é€šè¿‡è®°å½•åˆ é™¤äº†å®ƒçš„physicså’Œmarkså­—æ®µã€‚æ˜¯ä¸æ˜¯æ¯”ä»¥å‰çš„æ–¹æ³•ç®€å•å¤šäº†ï¼Ÿ

